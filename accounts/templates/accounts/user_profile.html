{% extends "base.html" %} {% block page_styles %}
<style></style>
{% endblock %} {% block content %}
<div class="page-header">
  <h3 class="fw-bold mb-3">{{ user.get_full_name }}</h3>
</div>
<div class="row">
  <div class="col-md-12">
    <div class="overflow-auto">
      <ul class="nav nav-pills nav-secondary" id="pills-tab" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="pills-home-tab"
            data-bs-toggle="pill"
            href="#personal-details"
            role="tab"
            aria-controls="pills-home"
            aria-selected="true"
            >Personal Details</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="pills-profile-tab"
            data-bs-toggle="pill"
            href="#other-details"
            role="tab"
            aria-controls="pills-profile"
            aria-selected="false"
            >Other Details</a
          >
        </li>
      </ul>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="tab-content mt-2 mb-3" id="pills-tabContent">
          <div
            class="tab-pane fade show active"
            id="personal-details"
            role="tabpanel"
            aria-labelledby="pills-home-tab"
          >
            <div class="row" id="userProfileForm" data-user-id="{{ user.id }}">

              <!-- First Name -->
              <div class="col-md-6">
                <div class="form-group form-group-default">
                  <label>First Name</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-section="user"
                    data-field="first_name"
                    value="{{ user.first_name|default:'---' }}"
                  />
                </div>
              </div>

              <!-- Last Name -->
              <div class="col-md-6">
                <div class="form-group form-group-default">
                  <label>Last Name</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-section="user"
                    data-field="last_name"
                    value="{{ user.last_name|default:'---' }}"
                  />
                </div>
              </div>

              <!-- Email -->
              <div class="col-md-6">
                <div class="form-group form-group-default">
                  <label>Email</label>
                  <input
                    type="email"
                    class="form-control autosave-field"
                    data-section="user"
                    data-field="email"
                    value="{{ user.email|default:'---' }}"
                  />
                </div>
              </div>

              <!-- Phone -->
              <div class="col-md-6">
                <div class="form-group form-group-default">
                  <label>Phone</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-section="client_profile"
                    data-field="phone"
                    value="{{ user.client_profile.phone|default:'---' }}"
                  />
                </div>
              </div>

              <!-- City -->
              <div class="col-md-4">
                <div class="form-group form-group-default">
                  <label>City</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-section="client_profile"
                    data-field="city"
                    value="{{ user.client_profile.city|default:'---' }}"
                  />
                </div>
              </div>

              <!-- State -->
              <div class="col-md-4">
                <div class="form-group form-group-default">
                  <label>State</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-section="client_profile"
                    data-field="state"
                    value="{{ user.client_profile.state|default:'---' }}"
                  />
                </div>
              </div>

              <!-- Country -->
              <div class="col-md-4">
                <div class="form-group form-group-default">
                  <label>Country</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-section="client_profile"
                    data-field="country"
                    value="{{ user.client_profile.country|default:'---' }}"
                  />
                </div>
              </div>

              <!-- Status -->
              <div class="col-md-4">
                <div class="form-group form-group-default d-flex align-items-center justify-content-between">
                  <label class="mb-0">User Status</label>

                  <div class="form-check form-switch">
                    <input
                      class="form-check-input autosave-field"
                      type="checkbox"
                      data-section="user"
                      data-field="is_active"
                      {% if user.is_active %}checked{% endif %}
                    />
                  </div>
                </div>
              </div>

              <!-- Plan -->
              <div class="col-md-4">
                <div class="form-group form-group-default">
                  <label>Plan</label>
                  <select
                    class="form-control autosave-field"
                    data-section="client_profile"
                    data-field="plan"
                  >
                    <option value="ELITE" {% if user.client_profile.plan == 'ELITE' %}selected{% endif %}>Elite</option>
                    <option value="CORE" {% if user.client_profile.plan == 'CORE' %}selected{% endif %}>Core</option>
                    <option value="DIGITAL" {% if user.client_profile.plan == 'DIGITAL' %}selected{% endif %}>Digital</option>
                  </select>
                </div>
              </div>

              <!-- Company -->
              <div class="col-md-4">
                <div class="form-group form-group-default">
                  <label>Company</label>
                  <select
                    class="form-select autosave-field"
                    data-section="client_profile"
                    data-field="company"
                  >
                    <option value="">Individual / No Company</option>
                    {% for company in companies %}
                      <option
                        value="{{ company.id }}"
                        {% if user.client_profile.company_id == company.id %}selected{% endif %}
                      >
                        {{ company.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

            </div>
          </div>
          <div
            class="tab-pane fade"
            id="other-details"
            role="tabpanel"
            aria-labelledby="pills-contact-tab"
          >
            <p class="mb-2">
              Pityful a rethoric question ran over her cheek, then she continued
              her way. On her way she met a copy. The copy warned the Little
              Blind Text, that where it came from it would have been rewritten a
              thousand times and everything that was left from its origin would
              be the word "and" and the Little Blind Text should turn around and
              return to its own, safe country.
            </p>

            <p class="mb-2">
              But nothing the copy said could convince her and so it didnâ€™t take
              long until a few insidious Copy Writers ambushed her, made her
              drunk with Longe and Parole and dragged her into their agency,
              where they abused her for their
            </p>
          </div>
        </div>
      </div>
    </div>
    {% endblock %} {% block page_scripts %}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const tab = new URLSearchParams(window.location.search).get("tab");
        if (!tab) return;

        const target = document.querySelector(`.nav-link[href="#${tab}"]`);
        if (target) new bootstrap.Tab(target).show();
      });
      // When switching tabs, update URL parameter
      document.querySelectorAll('.nav-link[data-bs-toggle="pill"]').forEach(tab => {
        tab.addEventListener("shown.bs.tab", function (e) {
          const tabId = e.target.getAttribute("href").replace("#", "");
          const url = new URL(window.location);

          // If first tab, remove ?tab or reset it
          if (tabId === "personal-details") {
            url.searchParams.delete("tab");            // clears tab
            history.replaceState({}, "", url);         // update URL without reload
            return;
          }

          // Otherwise set tab param
          url.searchParams.set("tab", tabId);
          history.replaceState({}, "", url);
        });
      });
      (function () {
        const userForm = document.getElementById('userProfileForm');
        if (!userForm) return;

        const userId = userForm.dataset.userId;

        document.querySelectorAll('.autosave-field').forEach(input => {
          let initialValue = getValue(input);

          // Save on blur
          input.addEventListener('blur', () => {
            const currentValue = getValue(input);
            if (currentValue !== initialValue) {
              saveField(input, currentValue);
              initialValue = currentValue;
            }
          });

          // Save on Enter for text inputs
          input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
              e.preventDefault();
              input.blur();
            }
          });

          // Save immediately for select & checkbox
          if (input.tagName === 'SELECT' || input.type === 'checkbox') {
            input.addEventListener('change', () => {
              const currentValue = getValue(input);
              saveField(input, currentValue);
              initialValue = currentValue;
            });
          }
        });

        function getValue(input) {
          if (input.type === 'checkbox') {
            return input.checked;
          }
          return input.value;
        }

        function saveField(input, value) {
          const section = input.dataset.section;
          const field = input.dataset.field;

          // Visual loading state
          input.classList.add('opacity-50');

          fetch(`/users/update/${userId}/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCSRF(),
            },
            body: JSON.stringify({
              section: section,
              field: field,
              value: value,
            }),
          })
            .then(res => res.json())
            .then(data => {
              input.classList.remove('opacity-50');

              if (data.success) {
                showSaved(input);
              } else {
                showError(input);
              }
            })
            .catch(() => {
              input.classList.remove('opacity-50');
              showError(input);
            });
        }

        function showSaved(input) {
          showStatus(input, 'Saved!', 'text-success');
        }

        function showError(input) {
          showStatus(input, 'Error', 'text-danger');
        }

        function showStatus(input, text, cls) {
          let badge = input.parentElement.querySelector('.autosave-status');
          if (!badge) {
            badge = document.createElement('small');
            badge.className = `autosave-status ${cls} ms-2 fw-semibold`;
            input.parentElement.appendChild(badge);
          }
          badge.textContent = text;

          setTimeout(() => badge.remove(), 1500);
        }
      })();
    </script>
    {% endblock %}