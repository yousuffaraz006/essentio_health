{% extends "base.html" %}

{% block page_styles %}
<style>

</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
    <div>
        <h3 class="fw-bold mb-3">Companies</h3>
    </div>
    <div class="ms-md-auto py-2 py-md-0">
        <a href="#" class="btn btn-label-info btn-round me-2">Manage</a>
        <button class="btn btn-primary btn-round ms-auto" data-bs-toggle="modal" data-bs-target="#createCompanyModal"
            class="btn btn-primary btn-round">Add Company</button>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row mb-3 g-2 justify-content-between">
                    <!-- Created Before -->
                    <div class="col-md-3 d-flex flex-column">
                        <label class="form-label mb-1">Created Before</label>
                        <input type="date" id="createdBefore" class="form-control" />
                    </div>

                    <!-- Search -->
                    <div class="col-md-4">
                        <label class="form-label mb-1">Search</label>
                        <input
                        type="text"
                        id="companySearch"
                        class="form-control"
                        placeholder="Search companies..."
                        />
                    </div>

                    <!-- Created After -->
                    <div class="col-md-3 d-flex flex-column">
                        <label class="form-label mb-1">Created After</label>
                        <input type="date" id="createdAfter" class="form-control" />
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="display table soft-table">
                        <thead>
                            <tr>
                                <th>Added On</th>
                                <th>Company Name</th>
                                <th>City</th>
                                <th>State</th>
                                <th>Active Users</th>
                            </tr>
                        </thead>
                        <tbody id="companiesTableBody"></tbody>
                    </table>
                </div>
                <nav class="mt-3">
                    <ul class="pagination justify-content-end mb-0" id="companiesPagination">
                        <!-- JS will inject buttons here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <div class="card-body">
        <!-- Modal -->
        <div class="modal fade" id="createCompanyModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title">
                            <span class="fw-mediumbold"> New Company</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        <form id="createCompanyForm">
                            <div class="row">

                                <!-- Company Name -->
                                <div class="col-sm-6">
                                    <div class="form-group form-group-default">
                                        <label>Company Name</label>
                                        <input id="companyName" type="text" name="name" class="form-control"
                                            placeholder="Enter company name" />
                                    </div>
                                </div>

                                <!-- CEO -->
                                <div class="col-md-6">
                                    <div class="form-group form-group-default">
                                        <label>CEO</label>
                                        <input id="ceo" type="text" name="ceo" class="form-control"
                                            placeholder="Enter CEO name" />
                                    </div>
                                </div>

                                <!-- Business Size -->
                                <div class="col-sm-6">
                                    <div class="form-group form-group-default">
                                        <label>Business Size</label>
                                        <input id="businessSize" type="text" name="business_size" class="form-control"
                                            placeholder="e.g. 100, 250, 500" />
                                    </div>
                                </div>

                                <!-- City -->
                                <div class="col-md-6">
                                    <div class="form-group form-group-default">
                                        <label>City</label>
                                        <input id="city" type="text" name="city" class="form-control"
                                            placeholder="Enter city" />
                                    </div>
                                </div>

                                <!-- State -->
                                <div class="col-md-6">
                                    <div class="form-group form-group-default">
                                        <label>State</label>
                                        <input id="state" type="text" name="state" class="form-control"
                                            placeholder="Enter state" />
                                    </div>
                                </div>

                                <!-- Country -->
                                <div class="col-md-6">
                                    <div class="form-group form-group-default">
                                        <label>Country</label>
                                        <input id="country" type="text" name="country" class="form-control"
                                            placeholder="Enter country" />
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="col-sm-12">
                                    <div class="form-group form-group-default">
                                        <label>Notes</label>
                                        <input id="notes" type="text" name="notes" class="form-control"
                                            placeholder="Enter notes" />
                                    </div>
                                </div>

                            </div>
                        </form>
                    </div>

                    <div class="modal-footer border-0">
                        <button type="submit" form="createCompanyForm" class="btn btn-primary">
                            Add Company
                        </button>
                        <button type="reset" class="btn btn-danger" id="closeCompanyModal" data-bs-dismiss="modal">
                            Close
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block page_scripts %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const companyForm = document.getElementById('createCompanyForm');
        // const companyModal = new bootstrap.Modal(document.getElementById('companyModal'));

        companyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = new FormData(companyForm);
            const resp = await fetch("{% url 'companies:company_create_url' %}", { method: 'POST', headers: { 'X-CSRFToken': getCSRF() }, body: form });
            if (resp.ok) {
                location.reload();
            } else {
                const err = await resp.json();
                alert(Object.keys(err.errors).join(', '));
            }
        });
    });
    let debounceTimer = null;
    let currentPage = 1;

    function fetchCompanies() {
        const q = document.getElementById('companySearch').value;
        const createdAfter = document.getElementById('createdAfter').value;
        const createdBefore = document.getElementById('createdBefore').value;

        const params = new URLSearchParams({
            q,
            created_after: createdAfter,
            created_before: createdBefore,
            page: currentPage
        });

        fetch(`/companies/api/?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                console.log(data);
                renderCompanies(data.results);
                renderPagination(data.pagination);
            });
    }

    function renderCompanies(companies) {
        const tbody = document.getElementById('companiesTableBody');
        tbody.innerHTML = '';

        if (!companies.length) {
            tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted">
                No companies found
                </td>
            </tr>`;
            return;
        }

        companies.forEach(company => {
            tbody.insertAdjacentHTML('beforeend', `
            <tr onclick="window.location='${company.id}'" style="cursor:pointer;">
                <td>${company.added_on}</td>
                <td>${company.name}</td>
                <td>${company.city || '—'}</td>
                <td>${company.state || '—'}</td>
                <td>${company.active_users}</td>
            </tr>
            `);
        });
    }

    function goToPage(page) {
        currentPage = page;
        fetchCompanies();
    }

    function renderPagination(pagination) {
        const ul = document.getElementById('companiesPagination');
        ul.innerHTML = '';

        if (pagination.has_previous) {
            ul.insertAdjacentHTML('beforeend', `
            <li class="page-item">
                <button class="page-link" onclick="goToPage(${pagination.page - 1})">
                Previous
                </button>
            </li>
            `);
        }

        ul.insertAdjacentHTML('beforeend', `
            <li class="page-item disabled">
            <span class="page-link">
                Page ${pagination.page} of ${pagination.total_pages}
            </span>
            </li>
        `);

        if (pagination.has_next) {
            ul.insertAdjacentHTML('beforeend', `
            <li class="page-item">
                <button class="page-link" onclick="goToPage(${pagination.page + 1})">
                Next
                </button>
            </li>
            `);
        }
    }

    document.getElementById('companySearch').addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            currentPage = 1;
            fetchCompanies();
        }, 500);
    });

    document.getElementById('createdAfter').addEventListener('change', () => {
        currentPage = 1;
        fetchCompanies();
    });

    document.getElementById('createdBefore').addEventListener('change', () => {
        currentPage = 1;
        fetchCompanies();
    });
    document.addEventListener('DOMContentLoaded', fetchCompanies);
</script>
{% endblock %}