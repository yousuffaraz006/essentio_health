{% extends "base.html" %}
{% block page_styles %}
<style>
  .poc-card-full {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    transition: all 0.25s ease;
    overflow: visible;
  }

  .poc-card-full:hover {
    box-shadow: 0 8px 26px rgba(0,0,0,0.08);
    transform: translateY(-1px);
  }

  .poc-name {
    font-weight: 600;
    font-size: 15px;
  }

  .btn-outline-primary:hover {
    background-color: #1d7af3;
    color: #fff;
  }

  .btn-outline-danger:hover {
    background-color: #dc3545;
    color: #fff;
  }
  @media (max-width: 576px) {
    .poc-card-full .card-body {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
  }
</style>
{% endblock %}
{% block content %}
<div class="page-header">
  <h3 class="fw-bold mb-3">{{ company.name }}</h3>
</div>
<div class="row">
  <div class="col-md-12">
    <div class="overflow-auto">
  <ul
    class="nav nav-pills nav-secondary flex-nowrap"
    id="pills-tab"
    role="tablist"
    style="white-space: nowrap;"
  >
    <li class="nav-item">
      <a
        class="nav-link active"
        id="pills-home-tab"
        data-bs-toggle="pill"
        href="#personal-details"
        role="tab"
        aria-selected="true"
      >
        Company Details
      </a>
    </li>

    <li class="nav-item">
      <a
        class="nav-link"
        id="pills-profile-tab"
        data-bs-toggle="pill"
        href="#employees-details"
        role="tab"
        aria-selected="false"
      >
        Users Details
      </a>
    </li>
    <li class="nav-item">
      <a
        class="nav-link"
        id="pills-profile-tab"
        data-bs-toggle="pill"
        href="#poc-details"
        role="tab"
        aria-selected="false"
      >
        POCs Details
      </a>
    </li>
  </ul>
</div>


    <div class="card">
      <div class="card-body">
        <div class="tab-content mt-2 mb-3" id="pills-tabContent">
          <div
            class="tab-pane fade show active"
            id="personal-details"
            role="tabpanel"
            aria-labelledby="pills-home-tab"
          >
            <div class="row" id="companyDetailsForm" data-company-id="{{ company.id }}">

              <!-- Company Name -->
              <div class="col-sm-6">
                <div class="form-group form-group-default">
                  <label>Company Name</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-field="name"
                    value="{{ company.name }}"
                  />
                </div>
              </div>

              <!-- CEO -->
              <div class="col-md-6">
                <div class="form-group form-group-default">
                  <label>CEO</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-field="ceo"
                    value="{{ company.ceo|default:'---' }}"
                  />
                </div>
              </div>

              <!-- Business Size -->
              <div class="col-sm-6">
                <div class="form-group form-group-default">
                  <label>Business Size</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-field="size"
                    value="{{ company.size|default:'---' }}"
                  />
                </div>
              </div>

              <!-- City -->
              <div class="col-md-6">
                <div class="form-group form-group-default">
                  <label>City</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-field="city"
                    value="{{ company.city|default:'---' }}"
                  />
                </div>
              </div>

              <!-- State -->
              <div class="col-md-6">
                <div class="form-group form-group-default">
                  <label>State</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-field="state"
                    value="{{ company.state|default:'---' }}"
                  />
                </div>
              </div>

              <!-- Country -->
              <div class="col-md-6">
                <div class="form-group form-group-default">
                  <label>Country</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-field="country"
                    value="{{ company.country|default:'---' }}"
                  />
                </div>
              </div>

              <!-- Notes -->
              <div class="col-sm-12">
                <div class="form-group form-group-default">
                  <label>Notes</label>
                  <input
                    type="text"
                    class="form-control autosave-field"
                    data-field="notes"
                    value="{{ company.notes|default:'---' }}"
                  />
                </div>
              </div>

            </div>
          </div>
          <div
            class="tab-pane fade"
            id="employees-details"
            role="tabpanel"
            aria-labelledby="pills-contact-tab"
          >
            <div class="d-flex justify-content-end gap-2 mb-3">
              <!-- Add User -->
              <a href="{% url 'accounts:add_user_url' %}?company_id={{ company.id }}" 
                class="btn btn-primary btn-sm">
                Add User
              </a>

              <!-- Upload CSV -->
              <a href="{% url 'accounts:upload_bulk_clients_page_url' %}?company_id={{ company.id }}" 
                class="btn btn-success btn-sm">
                Upload CSV
              </a>
            </div>
            <div class="table-responsive">
              <table class="basic-datatables display table soft-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Plan</th>
                    <th>Contact</th>
                    <th>Location</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in users %}
                  <tr>
                    <td>{{ user.first_name }} {{ user.last_name }}</td>
                    <td>{{ user.client_profile.plan }}</td>
                    <td>
                      {{ user.email }}
                      <p class="text-muted">{{ user.client_profile.phone }}</p>
                    </td>
                    <td>
                      {% if user.client_profile.city or user.client_profile.state or user.client_profile.country %}
                      {{ user.client_profile.city }}{% if user.client_profile.city and user.client_profile.state %},{% endif %}
                      {{ user.client_profile.state }}{% if user.client_profile.state and user.client_profile.country %},{% endif %}
                      {{ user.client_profile.country }}
                      {% else %}
                      -----
                      {% endif %}
                    </td>
                    <td>
                      <a href="{% url 'accounts:user_profile_url' user.id %}" class="btn btn-sm btn-primary">View</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <div
            class="tab-pane fade"
            id="poc-details"
            role="tabpanel"
            aria-labelledby="pills-contact-tab"
          >
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Points of Contact</h5>

              <button
                class="btn btn-primary btn-sm"
                id="addPocBtn"
              >
                <i class="fa fa-plus me-1"></i>
                Add POC
              </button>
            </div>
            <div id="pocCardsContainer"></div>
            <div
              id="pocEmptyState"
              class="text-muted text-center py-4 d-none"
            >
              No points of contact added yet.
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="pocModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title" id="pocModalTitle">Add POC</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <form id="pocForm">
              {% csrf_token %}
              <input type="hidden" id="pocId" />
              <input type="hidden" id="pocCompanyId" value="{{ company.id }}" />

              <div class="form-group form-group-default">
                <label>Name</label>
                <input type="text" id="pocName" class="form-control" required />
              </div>

              <div class="form-group form-group-default">
                <label>Designation</label>
                <input type="text" id="pocDesignation" class="form-control" required />
              </div>

              <div class="form-group form-group-default">
                <label>Email</label>
                <input type="email" id="pocEmail" class="form-control" required />
              </div>

              <div class="form-group form-group-default d-flex justify-content-between align-items-center">
                <label class="mb-0">Access Master Dashboard</label>
                <input type="checkbox" id="pocAccess" />
              </div>

            </form>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-primary" id="savePocBtn">Save</button>
          </div>

        </div>
      </div>
    </div>
    <div class="modal fade" id="deletePocModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">Delete POC</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            Are you sure you want to delete this point of contact?
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-danger" id="confirmDeletePocBtn">
              Delete
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block page_scripts %}
<script>
  // When switching tabs, update URL parameter
  document.querySelectorAll('.nav-link[data-bs-toggle="pill"]').forEach(tab => {
    tab.addEventListener("shown.bs.tab", function (e) {
      const tabId = e.target.getAttribute("href").replace("#", "");
      const url = new URL(window.location);

      // If first tab, remove ?tab or reset it
      if (tabId === "personal-details") {
        url.searchParams.delete("tab");            // clears tab
        history.replaceState({}, "", url);         // update URL without reload
        return;
      }

      // Otherwise set tab param
      url.searchParams.set("tab", tabId);
      history.replaceState({}, "", url);
    });
  });
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

  document.querySelectorAll('.autosave-field').forEach(input => {
    let initialValue = input.value;

    input.addEventListener('blur', () => {
      if (input.value !== initialValue) {
        saveField(input);
        initialValue = input.value;
      }
    });

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        input.blur();
      }
    });
  });

  function saveField(input) {
    const companyId = document.getElementById('companyDetailsForm').dataset.companyId;
    const field = input.dataset.field;
    const value = input.value;

    fetch(`/companies/${companyId}/edit/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF(),
      },
      body: JSON.stringify({ field, value })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showSaved(input);
      } else {
        console.log('Failed to save');
      }
    });
  }

  function showSaved(input) {
    const badge = document.createElement('small');
    badge.className = 'text-success fw-semibold ms-2';
    badge.innerText = 'Saved!';
    input.parentElement.appendChild(badge);

    setTimeout(() => badge.remove(), 1500);
  }

  const companyId = "{{ company.id }}";
  const container = document.getElementById("pocCardsContainer");
  const emptyState = document.getElementById("pocEmptyState");

  fetch(`/companies/pocs/${companyId}/`)
  .then(res => res.json())
  .then(data => {
    console.log(data);
    container.innerHTML = "";

    if (!data.pocs || data.pocs.length === 0) {
      emptyState.classList.remove("d-none");
      return;
    }

    emptyState.classList.add("d-none");

    data.pocs.forEach(poc => {
      container.insertAdjacentHTML(
        "beforeend",
        renderPocCard(poc)
      );
    });
  })
  .catch(() => {
    emptyState.classList.remove("d-none");
  });

  function renderPocCard(poc) {
    return `
      <div class="col-12 mb-3">
        <div class="card poc-card-full">
          <div class="card-body d-flex justify-content-between align-items-center">

            <div>
              <h6 class="mb-1 poc-name">${poc.name}</h6>
              <div class="small poc-designation">${poc.designation}</div>

              <div class="small">
                <i class="fa fa-envelope me-1 text-muted"></i>
                <span class="poc-email">${poc.email}</span>
              </div>
            </div>

            <div class="d-flex align-items-center gap-3">
              <span
                class="badge bg-light text-dark poc-access"
                data-access="${poc.access_master_dashboard}"
              >
                Dashboard Access:
                <strong class="ms-1 ${poc.access_master_dashboard ? 'text-success' : 'text-danger'}">
                  ${poc.access_master_dashboard ? 'Yes' : 'No'}
                </strong>
              </span>

              <div class="d-flex gap-2">
                <button
                  class="btn btn-sm btn-outline-primary edit-poc-btn"
                  data-id="${poc.id}"
                >
                  <i class="fa fa-edit"></i>
                </button>

                <button
                  class="btn btn-sm btn-outline-danger delete-poc-btn"
                  data-id="${poc.id}"
                >
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;
  }
  let activePocId = null;

  // OPEN CREATE MODAL
  document.getElementById("addPocBtn").addEventListener("click", () => {
    activePocId = null;
    document.getElementById("pocModalTitle").innerText = "Add POC";
    document.getElementById("pocForm").reset();
    new bootstrap.Modal(document.getElementById("pocModal")).show();
  });

  // OPEN EDIT MODAL
  document.addEventListener("click", e => {
    const editBtn = e.target.closest(".edit-poc-btn");
    if (!editBtn) return;

    e.preventDefault();

    const card = editBtn.closest(".poc-card-full");
    activePocId = editBtn.dataset.id;

    document.getElementById("pocModalTitle").innerText = "Edit POC";

    document.getElementById("pocName").value =
      card.querySelector(".poc-name")?.innerText || "";

    document.getElementById("pocDesignation").value =
      card.querySelector(".poc-designation")?.innerText || "";

    document.getElementById("pocEmail").value =
      card.querySelector(".poc-email")?.innerText || "";

    document.getElementById("pocAccess").checked =
      card.querySelector(".poc-access")?.dataset.access === "true";

    new bootstrap.Modal(document.getElementById("pocModal")).show();
  });
  
  // SAVE (CREATE / UPDATE)
  document.getElementById("savePocBtn").addEventListener("click", () => {
    const url = activePocId
      ? `/companies/pocs/${activePocId}/update/`
      : `/companies/pocs/create/`;

    const data = new FormData();
    data.append("company_id", document.getElementById("pocCompanyId").value);
    data.append("name", document.getElementById("pocName").value);
    data.append("designation", document.getElementById("pocDesignation").value);
    data.append("email", document.getElementById("pocEmail").value);
    data.append(
      "access_master_dashboard",
      document.getElementById("pocAccess").checked
    );

    fetch(url, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRF() },
      body: data,
    })
    .then(res => res.json())
    .then(data => {
      if(data.success){
        location.reload();
      }
    });
  });

  // OPEN DELETE MODAL
  document.addEventListener("click", e => {
    const delBtn = e.target.closest(".delete-poc-btn");
    if (!delBtn) return;

    e.preventDefault();
    activePocId = delBtn.dataset.id;
    new bootstrap.Modal(document.getElementById("deletePocModal")).show();
  });

  // CONFIRM DELETE
  document.getElementById("confirmDeletePocBtn").addEventListener("click", () => {
    fetch(`/companies/pocs/${activePocId}/delete/`, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRF() },
    }).then(() => location.reload());
  });
  document.addEventListener("DOMContentLoaded", function () {
    const tab = new URLSearchParams(window.location.search).get("tab");
    if (!tab) return;                             // no tab param means stay on first tab

    const target = document.querySelector(`.nav-link[href="#${tab}"]`);
    if (target) new bootstrap.Tab(target).show(); // open the correct tab
  });
</script>
{% endblock %}